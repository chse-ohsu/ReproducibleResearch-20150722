---
title: "Reproducible Research Demo"
author: "OHSU Center for Health Systems Effectiveness"
date: "Wednesday, July 22, 2015"
output: 
  html_document:
    toc: TRUE
---

Last update by Stephanie Renfro (<renfrst@ohsu.edu>) on `r paste(Sys.time())` using `r R.version.string`.


## Purpose

This work was inspired by the following email from Farmer Ben.

```
From: Ben Chan 
Sent: Thursday, June 11, 2015 4:04 PM
To: Stephanie Renfro
Subject: What to feed chicks

Hello,

I'm receiving 20 baby chicks next month. Can you help me decide what to feed them? I'm choosing between the following four diets:

1.  Grower diet
2.  Layer diet
3.	Breeder diet
4.	High cluckage diet

Thanks,
Ben

-----------------------------------------------------------------
Ben Chan, Farmer and Research Associate
OHSU Center for Health Systems Effectiveness
Office: 3030 SW Moody | Mail Code: MDYCHSE
www.ohsu.edu/chse
```


## Preliminaries

Start clock to calculate total runtime.

```{r}
start_program <- proc.time()
```

Load needed packages:

  * *data.table* - for faster processing  
  * *knitr* - for better tables ("kable" function)
  * *ggplot2* - for pretty plots  
  * *knitr* - for better table display    
  
```{r, warning=FALSE}
packages <- c("data.table", "ggplot2", "knitr")
sapply(packages, require, character.only=TRUE, quietly=TRUE)
```


## Prepare Data

This demo uses [data from an experiment on the effect of diet on early growth of chicks](http://www.inside-r.org/r-doc/datasets/ChickWeight), `ChickWeight`, which comes pre-loaded in any R session.

Let's take a look at the first few rows:

```{r}
head(ChickWeight)
```

Let's also print a summary of the data.

*Note, by specifying the option "echo = FALSE", the resulting output will display, but not the code that generated it.*

```{r, echo=FALSE}
summary(ChickWeight)
```

Convert to data.table for faster processing.

```{r}
ChickWeight <- data.table(ChickWeight)
```

Just for fun, let's create a table showing mean weight at times 0, 10, and 21 days, for each of the four diet types.

```{r, results='asis'}
mean_ChickWeight <- ChickWeight[Time %in% c(0,10,21),
                                list(mean_weight = round(mean(weight), digits=1)),
                                by = list(Diet,Time)]

kable(mean_ChickWeight)
```

## Growth for Individual Chicks

**The following plot illustrates the growth curve for individual chicks from 0 to 21 days.**

Colors represent the four diets. From this plot, it is difficult to distinguish between the performance of the four diets. 

In subsequent plots, we focus our attention on a single diet.

```{r, echo=FALSE}
ggplot() +
  geom_line(data=ChickWeight, aes(x=Time, y=weight, color=Diet, group=Chick)) +
  ggtitle("Growth Curve for Individual Chicks")
```

```{r, echo=FALSE}
# Identify the diet of interest
diet <- 1

# Identify R plot color associated with diet of interest
gg_color_hue <- function(n) {
  hues = seq(15, 375, length=n+1)
  hcl(h=hues, l=65, c=100)[1:n]
}
color <- gg_color_hue(4)[diet]
```


## Focus: Diet `r diet`

### Individual growth curves

Plot individual chick growth curves, highlighting the results for chicks consuming Diet `r diet`.

```{r, echo=FALSE}
ggplot() +
  geom_line(data=ChickWeight, aes(x=Time, y=weight, color=Diet, group=Chick), alpha=.3) +
  geom_line(data=ChickWeight[Diet==diet], aes(x=Time, y=weight, color=Diet, group=Chick), size=0.7) +
  ggtitle(bquote(atop("Growth Curve for Individual Chicks",atop(italic(.(paste("Highlighted: Diet",diet)))))))
```

### Fitted growth curves

Plot fitted growth curves, highlighting the results for chicks consuming Diet `r diet`.

```{r, echo=FALSE, message=FALSE}
linesize <- rep(0.5,4)
linesize[diet] <- 1
ggplot() +
  geom_point(data=ChickWeight, aes(x=Time, y=weight, colour=Diet), alpha=.3, size=1.5) +
  geom_smooth(data=ChickWeight, aes(x=Time, y=weight, colour=Diet), alpha=.2) +
  geom_point(data=ChickWeight[Diet==diet], aes(x=Time, y=weight, colour=Diet), size=1.5) +
  geom_smooth(data=ChickWeight[Diet==diet], aes(x=Time, y=weight, colour=Diet), alpha=.2, size=.8) +
  guides(colour=guide_legend(override.aes=list(size=linesize, shape=c(NA,NA,NA,NA)))) +
  ggtitle(bquote(atop("Fitted Growth Curves",atop(italic(.(paste("Highlighted: Diet",diet)))))))
```

### Final weight density

Plot densities by diet for chicks' final weights (day 21), highlighting the results for chicks consuming Diet `r diet`.

```{r, echo=FALSE}
ggplot(ChickWeight[Time==21], aes(x=weight, colour=Diet)) +
    geom_density() +
    geom_density(data=ChickWeight[Time==21 & Diet==diet], aes(x=weight), fill=color, alpha=.2, show_guide=FALSE) +
  ggtitle(bquote(atop("Density: Final Weight",atop(italic(.(paste("Highlighted: Diet",diet)))))))
```


## Wrap Up

Calculate total runtime.

```{r}
time_program <- proc.time()-start_program
print(paste("Total runtime:", format(time_program[3]/60,digits=3), "minutes"))
```

Clear memory.

```{r}
rm(list=ls())
invisible(gc())
```
